<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Novel Planner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <style id="baseStyles">
        :root {
            --primary-color: #3a506b;
            --secondary-color: #1c2541;
            --accent-color: #5bc0be;
            --text-color: #edf2f4;
            --bg-color: #0b132b;
            --card-color: #202e4a;
            --hover-color: #48639c;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --font-headings: var(--font-main);
            --content-width: 1200px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-main);
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        .sidebar {
            width: 250px;
            background-color: var(--secondary-color);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--accent-color);
        }
        
        .logo {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--accent-color);
            text-align: center;
            font-family: var(--font-headings);
        }
        
        .create-btn {
            background-color: var(--accent-color);
            color: var(--secondary-color);
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        
        .create-btn:hover {
            background-color: #4ca8a7;
        }
        
        .filter-container {
            margin-bottom: 15px;
        }
        
        .filter-container select {
            width: 100%;
            padding: 8px;
            background-color: var(--card-color);
            color: var(--text-color);
            border: 1px solid var(--accent-color);
            border-radius: 4px;
        }
        
        .search-container {
            margin-bottom: 15px;
        }
        
        .search-container input {
            width: 100%;
            padding: 8px;
            background-color: var(--card-color);
            color: var(--text-color);
            border: 1px solid var(--accent-color);
            border-radius: 4px;
        }
        
        .folders-container {
            margin-bottom: 15px;
        }
        
        .folder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid var(--accent-color);
        }
        
        .folder-title {
            font-weight: bold;
            color: var(--accent-color);
        }
        
        .folder-actions {
            display: flex;
            gap: 5px;
        }
        
        .folder-btn {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        
        .folder-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .folder-icon {
            width: 16px;
            height: 16px;
        }
        
        .folder-item {
            padding: 8px 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .folder-item:hover {
            background-color: var(--hover-color);
        }
        
        .folder-item.active {
            background-color: var(--primary-color);
            border-left: 3px solid var(--accent-color);
        }
        
        .folder-item-name {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .folder-count {
            background-color: var(--card-color);
            padding: 2px 5px;
            border-radius: 10px;
            font-size: 0.7rem;
        }
        
        .notes-container {
            flex: 1;
            overflow-y: auto;
        }
        
        .note-card {
            background-color: var(--card-color);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .note-card:hover {
            background-color: var(--hover-color);
        }
        
        .note-title {
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: var(--font-headings);
        }
        
        .note-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        
        .tag {
            background-color: var(--primary-color);
            color: var(--text-color);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .content-title {
            font-size: 1.5rem;
            font-weight: bold;
            font-family: var(--font-headings);
        }
        
        .action-btns {
            display: flex;
            gap: 10px;
        }
        
        .edit-btn, .delete-btn, .save-btn, .cancel-btn, .style-btn, .backup-btn, .restore-btn, .folder-manage-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .edit-btn {
            background-color: var(--accent-color);
            color: var(--secondary-color);
        }
        
        .delete-btn {
            background-color: #e63946;
            color: white;
        }
        
        .save-btn {
            background-color: #2a9d8f;
            color: white;
        }
        
        .cancel-btn {
            background-color: #6c757d;
            color: white;
        }
        
        .style-btn {
            background-color: #9b5de5;
            color: white;
        }
        
        .backup-btn {
            background-color: #fca311;
            color: #000;
        }
        
        .restore-btn {
            background-color: #3a86ff;
            color: white;
        }
        
        .folder-manage-btn {
            background-color: #5e60ce;
            color: white;
        }
        
        .content-body {
            flex: 1;
            overflow-y: auto;
        }
        
        .note-editor {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 15px;
        }
        
        .note-input {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            background-color: var(--card-color);
            color: var(--text-color);
            border: 1px solid var(--accent-color);
        }
        
        .note-textarea {
            flex: 1;
            padding: 10px;
            border-radius: 4px;
            background-color: var(--card-color);
            color: var(--text-color);
            border: 1px solid var(--accent-color);
            resize: none;
            font-family: monospace;
        }
        
        .tags-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            background-color: var(--card-color);
            border-radius: 4px;
            border: 1px solid var(--accent-color);
        }
        
        .tags-input {
            flex: 1;
            min-width: 100px;
            padding: 5px;
            background-color: transparent;
            color: var(--text-color);
            border: none;
            outline: none;
        }
        
        .selected-tag {
            display: flex;
            align-items: center;
            background-color: var(--primary-color);
            color: var(--text-color);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        
        .remove-tag {
            margin-left: 5px;
            cursor: pointer;
        }
        
        .folder-selector {
            padding: 10px;
            background-color: var(--card-color);
            border-radius: 4px;
            border: 1px solid var(--accent-color);
            margin-bottom: 15px;
        }
        
        .folder-selector select {
            width: 100%;
            padding: 5px;
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: 1px solid var(--accent-color);
            border-radius: 4px;
        }
        
        .relations-container {
            padding: 10px;
            background-color: var(--card-color);
            border-radius: 4px;
            border: 1px solid var(--accent-color);
        }
        
        .relation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .relation-select {
            flex: 1;
            padding: 5px;
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: 1px solid var(--accent-color);
            border-radius: 4px;
            margin-right: 5px;
        }
        
        .add-relation-btn {
            background-color: var(--accent-color);
            color: var(--secondary-color);
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .remove-relation {
            background-color: #e63946;
            color: white;
            border: none;
            padding: 2px 5px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }
        
        .markdown-content {
            line-height: 1.6;
            padding: 15px;
            background-color: var(--card-color);
            border-radius: 4px;
            border: 1px solid var(--accent-color);
        }
        
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            margin-top: 1em;
            margin-bottom: 0.5em;
            color: var(--accent-color);
            font-family: var(--font-headings);
        }
        
        .markdown-content p {
            margin-bottom: 1em;
        }
        
        .markdown-content ul, .markdown-content ol {
            margin-left: 20px;
            margin-bottom: 1em;
        }
        
        .markdown-content code {
            background-color: var(--secondary-color);
            padding: 2px 4px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .markdown-content pre {
            background-color: var(--secondary-color);
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin-bottom: 1em;
        }
        
        .markdown-content blockquote {
            border-left: 3px solid var(--accent-color);
            padding-left: 10px;
            margin-left: 0;
            color: #adb5bd;
        }
        
        .markdown-content img {
            max-width: 100%;
        }
        
        .related-notes {
            margin-top: 20px;
        }
        
        .related-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--accent-color);
            font-family: var(--font-headings);
        }
        
        .related-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .related-item {
            background-color: var(--card-color);
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .related-item:hover {
            background-color: var(--hover-color);
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: #6c757d;
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .no-note-selected {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: #6c757d;
        }
        
        /* Style Pack Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal {
            background-color: var(--card-color);
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            position: relative;
            border: 1px solid var(--accent-color);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--accent-color);
            padding-bottom: 10px;
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent-color);
            font-family: var(--font-headings);
        }
        
        .close-modal {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .style-packs {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .style-pack {
            border: 2px solid transparent;
            border-radius: 6px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .style-pack.active {
            border-color: var(--accent-color);
        }
        
        .style-pack-preview {
            height: 60px;
            border-radius: 4px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .custom-style-section {
            margin-top: 20px;
            border-top: 1px solid var(--accent-color);
            padding-top: 20px;
        }
        
        .custom-style-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .custom-style-input {
            padding: 8px;
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: 1px solid var(--accent-color);
            border-radius: 4px;
        }
        
        .custom-style-btn {
            background-color: var(--accent-color);
            color: var(--secondary-color);
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .settings-container {
            margin-top: 0px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        
        .settings-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-color);
            color: var(--text-color);
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            flex: 1;
            font-weight: bold;
            gap: 5px;
        }
        
        .settings-icon {
            width: 16px;
            height: 16px;
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: var(--card-color);
            color: var(--text-color);
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0;
            transform: translateY(20px);
            border-left: 4px solid var(--accent-color);
        }
        
        .toast.success {
            border-left-color: #2a9d8f;
        }
        
        .toast.error {
            border-left-color: #e63946;
        }
        
        .toast.info {
            border-left-color: #3a86ff;
        }
        
        .toast.warning {
            border-left-color: #fca311;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Backup Modal */
        .backup-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }
        
        .backup-option {
            background-color: var(--primary-color);
            padding: 15px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .backup-option-header {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--accent-color);
        }
        
        .backup-option-description {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.9;
        }
        
        .backup-option-btn {
            background-color: var(--accent-color);
            color: var(--secondary-color);
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            align-self: flex-start;
        }
        
        #importBackupFile {
            display: none;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 8px 15px;
            background-color: var(--accent-color);
            color: var(--secondary-color);
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .modal-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--accent-color);
            display: flex;
            justify-content: space-between;
        }
        
        .stats-container {
            margin-top: 15px;
            background-color: var(--primary-color);
            padding: 10px;
            border-radius: 5px;
        }
        
        .stats-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--accent-color);
        }
        
        .stats-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        
        /* Folder Modal */
        .folder-list {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .folder-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--primary-color);
            margin-bottom: 8px;
            border-radius: 4px;
        }
        
        .folder-list-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .folder-list-actions {
            display: flex;
            gap: 5px;
        }
        
        .folder-list-actions button {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        
        .folder-list-actions button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .folder-form {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--primary-color);
            border-radius: 5px;
        }
        
        .folder-form-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--accent-color);
        }
        
        .folder-form-input {
            width: 100%;
            padding: 8px;
            background-color: var(--card-color);
            color: var(--text-color);
            border: 1px solid var(--accent-color);
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .folder-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .folder-form-actions button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .folder-submit {
            background-color: var(--accent-color);
            color: var(--secondary-color);
        }
        
        .folder-cancel {
            background-color: #6c757d;
            color: white;
        }
        
        .folder-path {
            margin-bottom: 15px;
            padding: 5px 0;
            border-bottom: 1px dashed var(--accent-color);
            color: var(--accent-color);
            font-size: 0.9rem;
        }
        
        .folder-breadcrumb {
            display: inline-block;
            cursor: pointer;
            padding: 3px 5px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        
        .folder-breadcrumb:hover {
            background-color: var(--primary-color);
        }
        
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid var(--accent-color);
            }
            
            .main-content {
                height: calc(100vh - 200px);
            }
            
            .style-packs {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            .settings-container {
                flex-direction: column;
            }
        }
    </style>
    <!-- Custom style will be injected here -->
    <style id="customStyles"></style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">Fantasy Novel Planner</div>
        <div class="settings-container">
            <button class="create-btn" id="createNoteBtn" style="margin-bottom: 0;">Create Note</button>
        </div>
        <div class="settings-container">
            <button class="settings-btn" id="styleSettingsBtn">
                <svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 15a3 3 0 100-6 3 3 0 000 6z" />
                    <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z" />
                </svg>
                Style
            </button>
            <button class="settings-btn" id="backupSettingsBtn" style="background-color: #fca311; color: #000;">
                <svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 9l-7 7-7-7" />
                    <path d="M12 16V4" />
                    <rect x="5" y="20" width="14" height="0" />
                    <path d="M4 20h16" />
                </svg>
                Backup
            </button>
            <button class="settings-btn" id="folderSettingsBtn" style="background-color: #5e60ce;">
                <svg class="settings-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
                </svg>
                Folders
            </button>
        </div>
        <div class="filter-container">
            <select id="tagFilter">
                <option value="">All Tags</option>
            </select>
        </div>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search notes...">
        </div>
        <div class="folders-container" id="folderTreeContainer">
            <!-- Folder tree will be rendered here -->
        </div>
        <div class="notes-container" id="notesContainer"></div>
    </div>
    
    <div class="main-content" id="mainContent">
        <div class="no-note-selected" id="noNoteSelected">
            <div class="empty-icon">📝</div>
            <h2>No Note Selected</h2>
            <p>Select a note from the sidebar or create a new one to begin</p>
        </div>
    </div>

    <!-- Style Settings Modal -->
    <div id="styleModal" style="display: none;" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Style Settings</div>
                <button class="close-modal" id="closeStyleModal">&times;</button>
            </div>
            <div class="modal-content">
                <h3>Choose a Style Pack</h3>
                <div class="style-packs" id="stylePacksContainer">
                    <!-- Style packs will be added here -->
                </div>
                
                <div class="custom-style-section">
                    <h3>Add Custom Style</h3>
                    <div class="custom-style-form">
                        <input type="text" id="customStyleURL" class="custom-style-input" placeholder="Enter CSS URL...">
                        <button id="addCustomStyle" class="custom-style-btn">Add Custom Style</button>
                        
                        <p>Or upload a CSS file:</p>
                        <input type="file" id="customStyleFile" accept=".css">
                        
                        <h4>Create Custom Style</h4>
                        <textarea id="customStyleText" class="note-textarea" style="height: 150px;" placeholder="Enter custom CSS..."></textarea>
                        <button id="saveCustomStyle" class="custom-style-btn">Save Custom Style</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Backup Modal -->
    <div id="backupModal" style="display: none;" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Backup & Restore</div>
                <button class="close-modal" id="closeBackupModal">&times;</button>
            </div>
            <div class="modal-content">
                <p>Create backups of your novel planning data or restore from a previous backup.</p>
                
                <div class="stats-container">
                    <div class="stats-title">Current Data</div>
                    <div class="stats-item">
                        <span>Notes:</span>
                        <span id="noteCount">0</span>
                    </div>
                    <div class="stats-item">
                        <span>Folders:</span>
                        <span id="folderCount">0</span>
                    </div>
                    <div class="stats-item">
                        <span>Tags:</span>
                        <span id="tagCount">0</span>
                    </div>
                    <div class="stats-item">
                        <span>Last modified:</span>
                        <span id="lastModified">Never</span>
                    </div>
                </div>
                
                <div class="backup-options">
                    <div class="backup-option">
                        <div class="backup-option-header">Export Backup</div>
                        <div class="backup-option-description">
                            Download all your notes and folders as a JSON file to keep as a backup or transfer to another device.
                        </div>
                        <button id="exportBackupBtn" class="backup-option-btn">Export to JSON</button>
                    </div>
                    
                    <div class="backup-option">
                        <div class="backup-option-header">Import Backup</div>
                        <div class="backup-option-description">
                            Restore your notes and folders from a previously exported JSON backup file.
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <input type="file" id="importBackupFile" accept=".json">
                            <label for="importBackupFile" class="file-input-label">Choose File</label>
                            <span id="selectedFileName">No file selected</span>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button id="mergeBackupBtn" class="backup-option-btn" style="background-color: #3a86ff;">Merge with Current</button>
                            <button id="replaceBackupBtn" class="backup-option-btn" style="background-color: #e63946;">Replace All</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Folder Management Modal -->
    <div id="folderModal" style="display: none;" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Folder Management</div>
                <button class="close-modal" id="closeFolderModal">&times;</button>
            </div>
            <div class="modal-content">
                <p>Create, rename, and delete folders to organize your notes.</p>
                
                <div id="folderForm" style="display: none;" class="folder-form">
                    <div class="folder-form-title">Add New Folder</div>
                    <input type="text" id="folderNameInput" class="folder-form-input" placeholder="Folder name...">
                    <div class="folder-form-actions">
                        <button id="cancelFolderBtn" class="folder-cancel">Cancel</button>
                        <button id="saveFolderBtn" class="folder-submit">Save Folder</button>
                    </div>
                </div>
                
                <div id="folderRenameForm" style="display: none;" class="folder-form">
                    <div class="folder-form-title">Rename Folder</div>
                    <input type="text" id="folderRenameInput" class="folder-form-input" placeholder="New folder name...">
                    <input type="hidden" id="folderRenameId">
                    <div class="folder-form-actions">
                        <button id="cancelRenameBtn" class="folder-cancel">Cancel</button>
                        <button id="saveRenameBtn" class="folder-submit">Save</button>
                    </div>
                </div>
                
                <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <h3>Your Folders</h3>
                    <button id="addFolderBtn" class="folder-option-btn" style="background-color: var(--accent-color); color: var(--secondary-color); border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                        Add Folder
                    </button>
                </div>
                
                <div class="folder-list" id="folderListContainer">
                    <!-- Folders will be listed here -->
                </div>
                
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // Main application logic
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const createNoteBtn = document.getElementById('createNoteBtn');
            const notesContainer = document.getElementById('notesContainer');
            const folderTreeContainer = document.getElementById('folderTreeContainer');
            const mainContent = document.getElementById('mainContent');
            const noNoteSelected = document.getElementById('noNoteSelected');
            const tagFilter = document.getElementById('tagFilter');
            const searchInput = document.getElementById('searchInput');
            const styleSettingsBtn = document.getElementById('styleSettingsBtn');
            const backupSettingsBtn = document.getElementById('backupSettingsBtn');
            const folderSettingsBtn = document.getElementById('folderSettingsBtn');
            const styleModal = document.getElementById('styleModal');
            const backupModal = document.getElementById('backupModal');
            const folderModal = document.getElementById('folderModal');
            const closeStyleModal = document.getElementById('closeStyleModal');
            const closeBackupModal = document.getElementById('closeBackupModal');
            const closeFolderModal = document.getElementById('closeFolderModal');
            const stylePacksContainer = document.getElementById('stylePacksContainer');
            const addCustomStyleBtn = document.getElementById('addCustomStyle');
            const customStyleURL = document.getElementById('customStyleURL');
            const customStyleFile = document.getElementById('customStyleFile');
            const customStyleText = document.getElementById('customStyleText');
            const saveCustomStyleBtn = document.getElementById('saveCustomStyle');
            const exportBackupBtn = document.getElementById('exportBackupBtn');
            const importBackupFile = document.getElementById('importBackupFile');
            const selectedFileName = document.getElementById('selectedFileName');
            const mergeBackupBtn = document.getElementById('mergeBackupBtn');
            const replaceBackupBtn = document.getElementById('replaceBackupBtn');
            const noteCount = document.getElementById('noteCount');
            const folderCount = document.getElementById('folderCount');
            const tagCount = document.getElementById('tagCount');
            const lastModified = document.getElementById('lastModified');
            const folderListContainer = document.getElementById('folderListContainer');
            const addFolderBtn = document.getElementById('addFolderBtn');
            const folderForm = document.getElementById('folderForm');
            const folderNameInput = document.getElementById('folderNameInput');
            const saveFolderBtn = document.getElementById('saveFolderBtn');
            const cancelFolderBtn = document.getElementById('cancelFolderBtn');
            const folderRenameForm = document.getElementById('folderRenameForm');
            const folderRenameInput = document.getElementById('folderRenameInput');
            const folderRenameId = document.getElementById('folderRenameId');
            const saveRenameBtn = document.getElementById('saveRenameBtn');
            const cancelRenameBtn = document.getElementById('cancelRenameBtn');
            const toast = document.getElementById('toast');
            
            // State
            let notes = [];
            let folders = [];
            let currentNoteId = null;
            let currentFolderId = 'all'; // 'all' for all notes, or folder ID
            let isEditing = false;
            let db;
            
            // IndexedDB setup
            const DB_NAME = 'fantasyPlannerDB';
            const STORE_NAME = 'notes';
            const FOLDER_STORE = 'folders';
            const SETTINGS_STORE = 'settings';
            
            // Initialize IndexedDB
            function initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, 2); // Upgraded version to add folder store
                    
                    request.onerror = event => {
                        console.error("IndexedDB error:", event.target.errorCode);
                        reject('IndexedDB error: ' + event.target.errorCode);
                        
                        // Fallback to localStorage if IndexedDB fails
                        showToast("Unable to access IndexedDB. Falling back to localStorage.", "warning");
                        notes = JSON.parse(localStorage.getItem('fantasyNotes')) || [];
                        folders = JSON.parse(localStorage.getItem('fantasyFolders')) || [];
                        initializeFolders();
                        renderNotesList();
                        renderFolderTree();
                        updateTagOptions();
                        updateStats();
                        resolve();
                    };
                    
                    request.onupgradeneeded = event => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains(FOLDER_STORE)) {
                            db.createObjectStore(FOLDER_STORE, { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains(SETTINGS_STORE)) {
                            db.createObjectStore(SETTINGS_STORE, { keyPath: 'id' });
                        }
                    };
                    
                    request.onsuccess = event => {
                        db = event.target.result;
                        console.log("IndexedDB initialized successfully");
                        
                        // Load notes and folders
                        Promise.all([
                            loadNotes(),
                            loadFolders()
                        ]).then(([loadedNotes, loadedFolders]) => {
                            notes = loadedNotes;
                            folders = loadedFolders;
                            
                            initializeFolders();
                            renderNotesList();
                            renderFolderTree();
                            updateTagOptions();
                            updateStats();
                            
                            // Load saved style settings
                            loadStyleSettings().then(styleSettings => {
                                if (styleSettings && styleSettings.activeStyle) {
                                    applyStyle(styleSettings.activeStyle);
                                }
                            });
                            
                            resolve();
                        }).catch(error => {
                            console.error("Error loading data:", error);
                            reject(error);
                        });
                    };
                });
            }
            
            // Make sure we have at least the root folder
            function initializeFolders() {
                if (folders.length === 0) {
                    folders = [
                        {
                            id: 'root',
                            name: 'All Notes',
                            parentId: null,
                            created: new Date().toISOString(),
                            updated: new Date().toISOString()
                        }
                    ];
                    saveFolders();
                }
                
                // If notes don't have a folderId, assign them to the root folder
                notes.forEach(note => {
                    if (!note.folderId) {
                        note.folderId = 'root';
                    }
                });
                saveNotes();
            }
            
            // Load notes from IndexedDB
            function loadNotes() {
                return new Promise((resolve, reject) => {
                    if (!db) {
                        return resolve(JSON.parse(localStorage.getItem('fantasyNotes')) || []);
                    }
                    
                    try {
                        const transaction = db.transaction([STORE_NAME], 'readonly');
                        const store = transaction.objectStore(STORE_NAME);
                        const request = store.getAll();
                        
                        request.onsuccess = () => resolve(request.result || []);
                        request.onerror = (event) => {
                            console.error("Error loading notes:", event);
                            reject('Error loading notes');
                        };
                    } catch (error) {
                        console.error("Transaction error:", error);
                        reject(error);
                    }
                });
            }
            
            // Load folders from IndexedDB
            function loadFolders() {
                return new Promise((resolve, reject) => {
                    if (!db) {
                        return resolve(JSON.parse(localStorage.getItem('fantasyFolders')) || []);
                    }
                    
                    try {
                        const transaction = db.transaction([FOLDER_STORE], 'readonly');
                        const store = transaction.objectStore(FOLDER_STORE);
                        const request = store.getAll();
                        
                        request.onsuccess = () => resolve(request.result || []);
                        request.onerror = (event) => {
                            console.error("Error loading folders:", event);
                            reject('Error loading folders');
                        };
                    } catch (error) {
                        console.error("Transaction error:", error);
                        reject(error);
                    }
                });
            }
            
            // Save notes to IndexedDB
            function saveNotesToDB() {
                return new Promise((resolve, reject) => {
                    if (!db) {
                        // Fallback to localStorage
                        localStorage.setItem('fantasyNotes', JSON.stringify(notes));
                        updateTagOptions();
                        updateStats();
                        return resolve();
                    }
                    
                    try {
                        const transaction = db.transaction([STORE_NAME], 'readwrite');
                        const store = transaction.objectStore(STORE_NAME);
                        
                        // Clear existing notes
                        const clearRequest = store.clear();
                        
                        clearRequest.onsuccess = () => {
                            // Add all notes
                            let completed = 0;
                            
                            notes.forEach(note => {
                                const addRequest = store.add(note);
                                
                                addRequest.onsuccess = () => {
                                    completed++;
                                    if (completed === notes.length) {
                                        updateTagOptions();
                                        updateStats();
                                        resolve();
                                    }
                                };
                                
                                addRequest.onerror = (event) => {
                                    console.error("Error adding note:", event);
                                    reject('Error adding note');
                                };
                            });
                            
                            // If no notes, still resolve
                            if (notes.length === 0) {
                                updateTagOptions();
                                updateStats();
                                resolve();
                            }
                        };
                        
                        clearRequest.onerror = (event) => {
                            console.error("Error clearing notes:", event);
                            reject('Error clearing notes');
                        };
                        
                        transaction.onerror = (event) => {
                            console.error("Transaction error:", event);
                            reject('Transaction error');
                        };
                    } catch (error) {
                        console.error("Transaction creation error:", error);
                        
                        // Fallback to localStorage
                        localStorage.setItem('fantasyNotes', JSON.stringify(notes));
                        updateTagOptions();
                        updateStats();
                        resolve();
                    }
                });
            }
            
            // Save folders to IndexedDB
            function saveFoldersToDB() {
                return new Promise((resolve, reject) => {
                    if (!db) {
                        // Fallback to localStorage
                        localStorage.setItem('fantasyFolders', JSON.stringify(folders));
                        updateStats();
                        return resolve();
                    }
                    
                    try {
                        const transaction = db.transaction([FOLDER_STORE], 'readwrite');
                        const store = transaction.objectStore(FOLDER_STORE);
                        
                        // Clear existing folders
                        const clearRequest = store.clear();
                        
                        clearRequest.onsuccess = () => {
                            // Add all folders
                            let completed = 0;
                            
                            folders.forEach(folder => {
                                const addRequest = store.add(folder);
                                
                                addRequest.onsuccess = () => {
                                    completed++;
                                    if (completed === folders.length) {
                                        updateStats();
                                        resolve();
                                    }
                                };
                                
                                addRequest.onerror = (event) => {
                                    console.error("Error adding folder:", event);
                                    reject('Error adding folder');
                                };
                            });
                            
                            // If no folders, still resolve
                            if (folders.length === 0) {
                                updateStats();
                                resolve();
                            }
                        };
                        
                        clearRequest.onerror = (event) => {
                            console.error("Error clearing folders:", event);
                            reject('Error clearing folders');
                        };
                        
                        transaction.onerror = (event) => {
                            console.error("Transaction error:", event);
                            reject('Transaction error');
                        };
                    } catch (error) {
                        console.error("Transaction creation error:", error);
                        
                        // Fallback to localStorage
                        localStorage.setItem('fantasyFolders', JSON.stringify(folders));
                        updateStats();
                        resolve();
                    }
                });
            }
            
            // Simplified save functions for the app
            function saveNotes() {
                saveNotesToDB().then(() => {
                    console.log("Notes saved successfully");
                }).catch(error => {
                    console.error("Error saving notes:", error);
                    showToast("There was an error saving your notes. Some data may not be preserved.", "error");
                });
            }
            
            function saveFolders() {
                saveFoldersToDB().then(() => {
                    console.log("Folders saved successfully");
                    renderFolderTree();
                }).catch(error => {
                    console.error("Error saving folders:", error);
                    showToast("There was an error saving your folders. Some data may not be preserved.", "error");
                });
            }
            
            // Update stats for backup modal
            function updateStats() {
                if (noteCount) {
                    noteCount.textContent = notes.length;
                    folderCount.textContent = folders.length;
                    
                    const allTags = new Set();
                    let latestUpdate = null;
                    
                    notes.forEach(note => {
                        note.tags.forEach(tag => allTags.add(tag));
                        
                        const noteDate = new Date(note.updated);
                        if (!latestUpdate || noteDate > latestUpdate) {
                            latestUpdate = noteDate;
                        }
                    });
                    
                    tagCount.textContent = allTags.size;
                    
                    if (latestUpdate) {
                        lastModified.textContent = latestUpdate.toLocaleDateString() + ' ' + 
                                                   latestUpdate.toLocaleTimeString();
                    } else {
                        lastModified.textContent = 'Never';
                    }
                }
            }
            
            // Style pack management
            function loadStyleSettings() {
                return new Promise((resolve, reject) => {
                    if (!db) {
                        const settings = JSON.parse(localStorage.getItem('fantasyStyleSettings')) || {};
                        return resolve(settings);
                    }
                    
                    try {
                        const transaction = db.transaction([SETTINGS_STORE], 'readonly');
                        const store = transaction.objectStore(SETTINGS_STORE);
                        const request = store.get('styleSettings');
                        
                        request.onsuccess = () => {
                            resolve(request.result || {});
                        };
                        
                        request.onerror = (event) => {
                            console.error("Error loading style settings:", event);
                            reject('Error loading style settings');
                        };
                    } catch (error) {
                        console.error("Transaction error:", error);
                        const settings = JSON.parse(localStorage.getItem('fantasyStyleSettings')) || {};
                        resolve(settings);
                    }
                });
            }
            
            function saveStyleSettings(settings) {
                return new Promise((resolve, reject) => {
                    // Also save to localStorage as backup
                    localStorage.setItem('fantasyStyleSettings', JSON.stringify(settings));
                    
                    if (!db) {
                        return resolve();
                    }
                    
                    try {
                        const transaction = db.transaction([SETTINGS_STORE], 'readwrite');
                        const store = transaction.objectStore(SETTINGS_STORE);
                        
                        const settingsObj = { 
                            id: 'styleSettings',
                            ...settings 
                        };
                        
                        const request = store.put(settingsObj);
                        
                        request.onsuccess = () => resolve();
                        request.onerror = (event) => {
                            console.error("Error saving style settings:", event);
                            reject('Error saving style settings');
                        };
                    } catch (error) {
                        console.error("Transaction error:", error);
                        resolve(); // Continue anyway since we saved to localStorage
                    }
                });
            }
            
            // Define style packs
            const stylePacks = [
                {
                    id: 'default',
                    name: 'Default Dark',
                    css: `:root {
                        --primary-color: #3a506b;
                        --secondary-color: #1c2541;
                        --accent-color: #5bc0be;
                        --text-color: #edf2f4;
                        --bg-color: #0b132b;
                        --card-color: #202e4a;
                        --hover-color: #48639c;
                        --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        --font-headings: var(--font-main);
                    }`,
                    preview: {
                        bg: '#0b132b',
                        text: '#edf2f4',
                        accent: '#5bc0be'
                    }
                },
                {
                    id: 'light',
                    name: 'Light Mode',
                    css: `:root {
                        --primary-color: #6d9eeb;
                        --secondary-color: #e9ecef;
                        --accent-color: #4361ee;
                        --text-color: #212529;
                        --bg-color: #f8f9fa;
                        --card-color: #ffffff;
                        --hover-color: #d1ddf1;
                        --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        --font-headings: var(--font-main);
                    }`,
                    preview: {
                        bg: '#f8f9fa',
                        text: '#212529',
                        accent: '#4361ee'
                    }
                },
                {
                    id: 'forest',
                    name: 'Forest',
                    css: `:root {
                        --primary-color: #3a5a40;
                        --secondary-color: #1b4332;
                        --accent-color: #a3b18a;
                        --text-color: #f8f9fa;
                        --bg-color: #081c15;
                        --card-color: #2d6a4f;
                        --hover-color: #52b788;
                        --font-main: 'Georgia', serif;
                        --font-headings: 'Georgia', serif;
                    }`,
                    preview: {
                        bg: '#081c15',
                        text: '#f8f9fa',
                        accent: '#a3b18a'
                    }
                },
                {
                    id: 'sepia',
                    name: 'Sepia',
                    css: `:root {
                        --primary-color: #8b7e74;
                        --secondary-color: #c7b7a3;
                        --accent-color: #6d4c3d;
                        --text-color: #4d3e3e;
                        --bg-color: #f3e9dc;
                        --card-color: #e6d5b8;
                        --hover-color: #d7c0ae;
                        --font-main: 'Bookman Old Style', serif;
                        --font-headings: 'Bookman Old Style', serif;
                    }
                    
                    .markdown-content h1, .markdown-content h2, .markdown-content h3 {
                        color: var(--primary-color);
                        border-bottom: 1px solid var(--accent-color);
                        padding-bottom: 5px;
                    }`,
                    preview: {
                        bg: '#f3e9dc',
                        text: '#4d3e3e',
                        accent: '#6d4c3d'
                    }
                },
                {
                    id: 'cyberpunk',
                    name: 'Cyberpunk',
                    css: `:root {
                        --primary-color: #2b2b52;
                        --secondary-color: #0c0c0c;
                        --accent-color: #ff2975;
                        --text-color: #f0ece2;
                        --bg-color: #121212;
                        --card-color: #1a1a1a;
                        --hover-color: #341677;
                        --font-main: 'Courier New', monospace;
                        --font-headings: 'Impact', fantasy;
                    }
                    
                    .sidebar {
                        border-right: 2px solid var(--accent-color);
                    }
                    
                    .note-card {
                        border-left: 2px solid var(--accent-color);
                    }
                    
                    .markdown-content {
                        border: 1px solid var(--accent-color);
                    }`,
                    preview: {
                        bg: '#121212',
                        text: '#f0ece2',
                        accent: '#ff2975'
                    }
                }
            ];
            
            // Add custom styles from localStorage
            function loadCustomStyles() {
                const customStyles = JSON.parse(localStorage.getItem('fantasyCustomStyles')) || [];
                return customStyles;
            }
            
            function saveCustomStyles(customStyles) {
                localStorage.setItem('fantasyCustomStyles', JSON.stringify(customStyles));
            }
            
            // Apply style by ID
            function applyStyle(styleId) {
                // All available styles (built-in + custom)
                const allStyles = [...stylePacks, ...loadCustomStyles()];
                const style = allStyles.find(s => s.id === styleId);
                
                if (!style) return;
                
                // Update the custom styles element
                document.getElementById('customStyles').textContent = style.css;
                
                // Save the setting
                saveStyleSettings({ activeStyle: styleId });
                
                // Update active style in UI
                document.querySelectorAll('.style-pack').forEach(el => {
                    el.classList.toggle('active', el.dataset.id === styleId);
                });
            }
            
            // Render style packs
            function renderStylePacks() {
                stylePacksContainer.innerHTML = '';
                
                // Get current style
                loadStyleSettings().then(settings => {
                    const currentStyle = settings.activeStyle || 'default';
                    
                    // Add built-in style packs
                    stylePacks.forEach(style => {
                        const stylePack = document.createElement('div');
                        stylePack.className = 'style-pack';
                        stylePack.dataset.id = style.id;
                        
                        if (style.id === currentStyle) {
                            stylePack.classList.add('active');
                        }
                        
                        stylePack.innerHTML = `
                            <div class="style-pack-preview" style="background-color: ${style.preview.bg}; color: ${style.preview.text}; border: 1px solid ${style.preview.accent};">
                                Aa
                            </div>
                            <div>${style.name}</div>
                        `;
                        
                        stylePack.addEventListener('click', () => {
                            applyStyle(style.id);
                        });
                        
                        stylePacksContainer.appendChild(stylePack);
                    });
                    
                    // Add custom style packs
                    const customStyles = loadCustomStyles();
                    customStyles.forEach(style => {
                        const stylePack = document.createElement('div');
                        stylePack.className = 'style-pack';
                        stylePack.dataset.id = style.id;
                        
                        if (style.id === currentStyle) {
                            stylePack.classList.add('active');
                        }
                        
                        stylePack.innerHTML = `
                            <div class="style-pack-preview" style="background-color: ${style.preview?.bg || '#333'}; color: ${style.preview?.text || '#fff'};">
                                Aa
                            </div>
                            <div>${style.name}</div>
                            <button class="remove-style" data-id="${style.id}" style="margin-top: 5px; background-color: #e63946; color: white; border: none; padding: 2px 5px; border-radius: 3px; font-size: 0.7rem;">Remove</button>
                        `;
                        
                        stylePack.addEventListener('click', (e) => {
                            if (!e.target.classList.contains('remove-style')) {
                                applyStyle(style.id);
                            }
                        });
                        
                        stylePacksContainer.appendChild(stylePack);
                    });
                    
                    // Add event listeners to remove buttons
                    document.querySelectorAll('.remove-style').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const styleId = btn.dataset.id;
                            const customStyles = loadCustomStyles();
                            const updatedStyles = customStyles.filter(s => s.id !== styleId);
                            saveCustomStyles(updatedStyles);
                            
                            // If the removed style was active, switch to default
                            loadStyleSettings().then(settings => {
                                if (settings.activeStyle === styleId) {
                                    applyStyle('default');
                                }
                                renderStylePacks();
                            });
                        });
                    });
                });
            }
            
            // Add custom style from URL
            function addCustomStyleFromURL(url) {
                fetch(url)
                    .then(response => response.text())
                    .then(css => {
                        addCustomStyleFromText(css, `Style from ${url}`);
                    })
                    .catch(error => {
                        console.error("Error loading style from URL:", error);
                        showToast("Unable to load style from that URL. Please check the URL and try again.", "error");
                    });
            }
            
            // Add custom style from file
            function addCustomStyleFromFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const css = e.target.result;
                    addCustomStyleFromText(css, file.name.replace('.css', ''));
                };
                reader.onerror = () => {
                    showToast("Error reading file. Please try again with a different file.", "error");
                };
                reader.readAsText(file);
            }
            
            // Add custom style from text
            function addCustomStyleFromText(css, name) {
                const customStyles = loadCustomStyles();
                const id = 'custom-' + Date.now();
                
                // Try to extract preview colors
                let preview = {
                    bg: '#333',
                    text: '#fff',
                    accent: '#0af'
                };
                
                try {
                    // Extract colors using regex
                    const bgMatch = css.match(/--bg-color:\s*([^;]+);/);
                    const textMatch = css.match(/--text-color:\s*([^;]+);/);
                    const accentMatch = css.match(/--accent-color:\s*([^;]+);/);
                    
                    if (bgMatch) preview.bg = bgMatch[1].trim();
                    if (textMatch) preview.text = textMatch[1].trim();
                    if (accentMatch) preview.accent = accentMatch[1].trim();
                } catch (e) {
                    console.error("Error extracting colors:", e);
                }
                
                const style = {
                    id,
                    name: name || `Custom Style ${customStyles.length + 1}`,
                    css,
                    preview
                };
                
                customStyles.push(style);
                saveCustomStyles(customStyles);
                
                // Apply the new style
                applyStyle(id);
                
                // Update the UI
                renderStylePacks();
                showToast("Custom style added successfully!", "success");
                
                return style;
            }
            
            // Toast notification function
            function showToast(message, type = 'info') {
                toast.textContent = message;
                toast.className = 'toast ' + type;
                
                // Add show class to make it visible
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
            
            // Folder Management Functions
            function addFolder(name, parentId = 'root') {
                const newFolder = {
                    id: 'folder-' + Date.now(),
                    name: name.trim(),
                    parentId: parentId,
                    created: new Date().toISOString(),
                    updated: new Date().toISOString()
                };
                
                folders.push(newFolder);
                saveFolders();
                
                return newFolder;
            }
            
            function updateFolder(id, newName) {
                const folder = folders.find(f => f.id === id);
                if (folder) {
                    folder.name = newName.trim();
                    folder.updated = new Date().toISOString();
                    saveFolders();
                }
            }
            
            function deleteFolder(id) {
                // Get all descendant folder IDs to delete
                const descendantIds = getAllDescendantFolderIds(id);
                const allFolderIdsToDelete = [id, ...descendantIds];
                
                // Move all notes in these folders to the parent folder
                const folderToDelete = folders.find(f => f.id === id);
                const parentFolderId = folderToDelete ? folderToDelete.parentId || 'root' : 'root';
                
                notes.forEach(note => {
                    if (allFolderIdsToDelete.includes(note.folderId)) {
                        note.folderId = parentFolderId;
                    }
                });
                
                // Remove the folders
                folders = folders.filter(f => !allFolderIdsToDelete.includes(f.id));
                
                saveFolders();
                saveNotes();
                renderNotesList();
            }
            
            function getAllDescendantFolderIds(folderId) {
                const descendants = [];
                
                // Find direct children
                const children = folders.filter(f => f.parentId === folderId);
                
                // For each child, add it and its descendants
                children.forEach(child => {
                    descendants.push(child.id);
                    descendants.push(...getAllDescendantFolderIds(child.id));
                });
                
                return descendants;
            }
            
            function getFolderById(id) {
                return folders.find(f => f.id === id);
            }
            
            function getFolderPath(folderId) {
                const path = [];
                let currentId = folderId;
                
                while (currentId) {
                    const folder = getFolderById(currentId);
                    if (!folder) break;
                    
                    path.unshift(folder);
                    currentId = folder.parentId;
                }
                
                return path;
            }
            
            function getNotesInFolder(folderId, includeSubfolders = false) {
                if (folderId === 'all') {
                    return notes;
                }
                
                if (!includeSubfolders) {
                    return notes.filter(note => note.folderId === folderId);
                }
                
                // Include notes in subfolders
                const folderIds = [folderId, ...getAllDescendantFolderIds(folderId)];
                return notes.filter(note => folderIds.includes(note.folderId));
            }
            
            function getChildFolders(parentId) {
                return folders.filter(folder => folder.parentId === parentId)
                    .sort((a, b) => a.name.localeCompare(b.name));
            }
            
            // Render the folder tree in the sidebar
            function renderFolderTree() {
                folderTreeContainer.innerHTML = '';
                
                // Header with All Notes option
                const folderHeader = document.createElement('div');
                folderHeader.className = 'folder-header';
                folderHeader.innerHTML = `
                    <div class="folder-title">FOLDERS</div>
                `;
                folderTreeContainer.appendChild(folderHeader);
                
                // Add All Notes option
                const allNotesItem = document.createElement('div');
                allNotesItem.className = 'folder-item' + (currentFolderId === 'all' ? ' active' : '');
                allNotesItem.innerHTML = `
                    <div class="folder-item-name">
                        <svg class="folder-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
                        </svg>
                        All Notes
                    </div>
                    <div class="folder-count">${notes.length}</div>
                `;
                allNotesItem.addEventListener('click', () => {
                    currentFolderId = 'all';
                    renderNotesList();
                    renderFolderTree();
                });
                folderTreeContainer.appendChild(allNotesItem);
                
                // Add root folders
                const rootFolders = getChildFolders('root').filter(f => f.id !== 'root');
                rootFolders.forEach(folder => {
                    const folderElement = createFolderElement(folder);
                    folderTreeContainer.appendChild(folderElement);
                    
                    // Recursively add subfolders
                    renderSubFolders(folder.id, folderElement, 1);
                });
            }
            
            function renderSubFolders(parentId, parentElement, level) {
                const subFolders = getChildFolders(parentId);
                
                if (subFolders.length > 0) {
                    const subFolderContainer = document.createElement('div');
                    subFolderContainer.className = 'subfolder-container';
                    subFolderContainer.style.paddingLeft = (level * 15) + 'px';
                    
                    subFolders.forEach(folder => {
                        const folderElement = createFolderElement(folder);
                        subFolderContainer.appendChild(folderElement);
                        
                        // Recursively render subfolders
                        renderSubFolders(folder.id, subFolderContainer, level + 1);
                    });
                    
                    parentElement.appendChild(subFolderContainer);
                }
            }
            
            function createFolderElement(folder) {
                const folderNotes = getNotesInFolder(folder.id, true);
                const folderElement = document.createElement('div');
                folderElement.className = 'folder-item' + (currentFolderId === folder.id ? ' active' : '');
                folderElement.innerHTML = `
                    <div class="folder-item-name">
                        <svg class="folder-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
                        </svg>
                        ${folder.name}
                    </div>
                    <div class="folder-count">${folderNotes.length}</div>
                `;
                
                folderElement.addEventListener('click', () => {
                    currentFolderId = folder.id;
                    renderNotesList();
                    renderFolderTree();
                });
                
                return folderElement;
            }
            
            // Render the folder list in the folder management modal
            function renderFolderList() {
                folderListContainer.innerHTML = '';
                
                // Skip the root folder if it exists in the array
                const displayFolders = folders.filter(f => f.id !== 'root');
                
                if (displayFolders.length === 0) {
                    folderListContainer.innerHTML = '<p>No folders created yet.</p>';
                    return;
                }
                
                // Sort folders by name
                displayFolders.sort((a, b) => a.name.localeCompare(b.name));
                
                displayFolders.forEach(folder => {
                    const folderPath = getFolderPath(folder.id)
                        .map(f => f.name)
                        .join(' > ');
                    
                    const folderItem = document.createElement('div');
                    folderItem.className = 'folder-list-item';
                    folderItem.innerHTML = `
                        <div class="folder-list-name">
                            <svg class="folder-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
                            </svg>
                            ${folder.name}
                        </div>
                        <div class="folder-list-actions">
                            <button class="rename-folder" data-id="${folder.id}" title="Rename">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />
                                </svg>
                            </button>
                            <button class="delete-folder" data-id="${folder.id}" title="Delete">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                                </svg>
                            </button>
                        </div>
                    `;
                    
                    folderListContainer.appendChild(folderItem);
                });
                
                // Add event listeners to actions
                document.querySelectorAll('.rename-folder').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const folderId = e.currentTarget.dataset.id;
                        const folder = getFolderById(folderId);
                        
                        if (folder) {
                            folderRenameId.value = folderId;
                            folderRenameInput.value = folder.name;
                            folderRenameForm.style.display = 'block';
                            folderForm.style.display = 'none';
                        }
                    });
                });
                
                document.querySelectorAll('.delete-folder').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const folderId = e.currentTarget.dataset.id;
                        const folder = getFolderById(folderId);
                        
                        if (folder && confirm(`Are you sure you want to delete the folder "${folder.name}"? Notes inside will be moved to parent folder.`)) {
                            deleteFolder(folderId);
                            renderFolderList();
                            if (currentFolderId === folderId) {
                                currentFolderId = 'all';
                                renderNotesList();
                                renderFolderTree();
                            }
                            showToast(`Folder "${folder.name}" deleted`, "info");
                        }
                    });
                });
            }
            
            // Backup Export Function
            function exportBackup() {
                // Create a backup object with notes and folders
                const backup = {
                    notes: notes,
                    folders: folders,
                    version: "1.0",
                    timestamp: new Date().toISOString(),
                    type: "fantasy-novel-planner-backup"
                };
                
                // Convert to JSON string
                const backupJson = JSON.stringify(backup, null, 2);
                
                // Create a Blob with the JSON data
                const blob = new Blob([backupJson], {type: 'application/json'});
                
                // Create a download link
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `novel-planner-backup-${new Date().toISOString().slice(0, 10)}.json`;
                
                // Trigger download
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast("Backup file created successfully!", "success");
            }
            
            // Backup Import Function
            function importBackup(file, mergeMode = true) {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        // Validate the backup data
                        if (!backupData.type || backupData.type !== "fantasy-novel-planner-backup") {
                            throw new Error("Invalid backup file format");
                        }
                        
                        // Ensure we have notes and folders arrays
                        const importedNotes = Array.isArray(backupData.notes) ? backupData.notes : [];
                        const importedFolders = Array.isArray(backupData.folders) ? backupData.folders : [];
                        
                        if (mergeMode) {
                            // Process folders first (needed for notes)
                            mergeFolders(importedFolders);
                            
                            // Then process notes
                            mergeNotes(importedNotes);
                            
                            showToast(`Merged ${importedNotes.length} notes and ${importedFolders.length} folders`, "success");
                        } else {
                            // Just replace everything
                            notes = importedNotes;
                            folders = importedFolders;
                            
                            // Make sure we have a root folder
                            initializeFolders();
                            
                            showToast(`Imported ${notes.length} notes and ${folders.length} folders`, "success");
                        }
                        
                        // Save and update UI
                        saveNotes();
                        saveFolders();
                        renderNotesList();
                        renderFolderTree();
                        updateTagOptions();
                        updateStats();
                        
                        // Close the modal
                        backupModal.style.display = 'none';
                        
                    } catch (error) {
                        console.error("Error importing backup:", error);
                        showToast("Error importing backup. Invalid file format.", "error");
                    }
                };
                
                reader.onerror = () => {
                    showToast("Error reading backup file.", "error");
                };
                
                reader.readAsText(file);
            }
            
            // Merge imported folders with existing folders
            function mergeFolders(importedFolders) {
                // Create a map of existing folders by ID
                const existingFoldersMap = new Map();
                folders.forEach(folder => {
                    existingFoldersMap.set(folder.id, folder);
                });
                
                // Process each imported folder
                importedFolders.forEach(importedFolder => {
                    if (!existingFoldersMap.has(importedFolder.id)) {
                        // This is a new folder, add it
                        folders.push(importedFolder);
                    } else {
                        // This folder already exists, keep the newer version
                        const existingFolder = existingFoldersMap.get(importedFolder.id);
                        const existingDate = new Date(existingFolder.updated);
                        const importedDate = new Date(importedFolder.updated);
                        
                        if (importedDate > existingDate) {
                            // Replace with newer version
                            const index = folders.findIndex(f => f.id === importedFolder.id);
                            if (index !== -1) {
                                folders[index] = importedFolder;
                            }
                        }
                    }
                });
            }
            
            // Merge imported notes with existing notes
            function mergeNotes(importedNotes) {
                // Create a map for quick lookup of existing notes
                const existingNotesMap = new Map();
                notes.forEach(note => {
                    existingNotesMap.set(note.id, note);
                });
                
                // Track which relations need to be updated
                const relationUpdates = new Map();
                
                // First pass: add/update notes and collect relation changes
                importedNotes.forEach(importedNote => {
                    // Make sure the folder exists
                    if (importedNote.folderId && !folders.some(f => f.id === importedNote.folderId)) {
                        // Assign to root folder if the folder doesn't exist
                        importedNote.folderId = 'root';
                    }
                    
                    if (!existingNotesMap.has(importedNote.id)) {
                        // New note - add it
                        notes.push(importedNote);
                        // Track the relations for this new note
                        relationUpdates.set(importedNote.id, importedNote.relations || []);
                    } else {
                        // Existing note - check which is newer
                        const existingNote = existingNotesMap.get(importedNote.id);
                        const existingDate = new Date(existingNote.updated);
                        const importedDate = new Date(importedNote.updated);
                        
                        if (importedDate > existingDate) {
                            // Update with the newer version
                            const index = notes.findIndex(n => n.id === importedNote.id);
                            if (index !== -1) {
                                notes[index] = importedNote;
                                // Track the relations for this updated note
                                relationUpdates.set(importedNote.id, importedNote.relations || []);
                            }
                        }
                    }
                });
                
                // Second pass: fix relations to make sure they only point to existing notes
                relationUpdates.forEach((relations, noteId) => {
                    const note = notes.find(n => n.id === noteId);
                    if (note) {
                        // Filter out relations to notes that don't exist
                        note.relations = relations.filter(relatedId => 
                            notes.some(n => n.id === relatedId)
                        );
                    }
                });
            }
            
            // Event Listeners for backup/restore
            exportBackupBtn.addEventListener('click', exportBackup);
            
            // Import file selection
            importBackupFile.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    selectedFileName.textContent = e.target.files[0].name;
                } else {
                    selectedFileName.textContent = "No file selected";
                }
            });
            
            // Merge backup button
            mergeBackupBtn.addEventListener('click', () => {
                if (importBackupFile.files.length === 0) {
                    showToast("Please select a backup file first.", "warning");
                    return;
                }
                
                importBackup(importBackupFile.files[0], true);
            });
            
            // Replace backup button
            replaceBackupBtn.addEventListener('click', () => {
                if (importBackupFile.files.length === 0) {
                    showToast("Please select a backup file first.", "warning");
                    return;
                }
                
                if (confirm("This will replace all your current notes and folders with the backup data. This cannot be undone. Are you sure?")) {
                    importBackup(importBackupFile.files[0], false);
                }
            });
            
            // Folder management event listeners
            addFolderBtn.addEventListener('click', () => {
                folderForm.style.display = 'block';
                folderRenameForm.style.display = 'none';
                folderNameInput.value = '';
                folderNameInput.focus();
            });
            
            saveFolderBtn.addEventListener('click', () => {
                const folderName = folderNameInput.value.trim();
                if (folderName) {
                    addFolder(folderName);
                    folderForm.style.display = 'none';
                    renderFolderList();
                    renderFolderTree();
                    showToast(`Folder "${folderName}" created`, "success");
                } else {
                    showToast("Please enter a folder name", "warning");
                }
            });
            
            cancelFolderBtn.addEventListener('click', () => {
                folderForm.style.display = 'none';
            });
            
            saveRenameBtn.addEventListener('click', () => {
                const folderId = folderRenameId.value;
                const newName = folderRenameInput.value.trim();
                
                if (newName) {
                    updateFolder(folderId, newName);
                    folderRenameForm.style.display = 'none';
                    renderFolderList();
                    renderFolderTree();
                    showToast(`Folder renamed to "${newName}"`, "success");
                } else {
                    showToast("Please enter a folder name", "warning");
                }
            });
            
            cancelRenameBtn.addEventListener('click', () => {
                folderRenameForm.style.display = 'none';
            });
            
            // Event Listeners for style packs
            styleSettingsBtn.addEventListener('click', () => {
                renderStylePacks();
                styleModal.style.display = 'flex';
            });
            
            backupSettingsBtn.addEventListener('click', () => {
                updateStats();
                backupModal.style.display = 'flex';
            });
            
            folderSettingsBtn.addEventListener('click', () => {
                renderFolderList();
                folderModal.style.display = 'flex';
                folderForm.style.display = 'none';
                folderRenameForm.style.display = 'none';
            });
            
            closeStyleModal.addEventListener('click', () => {
                styleModal.style.display = 'none';
            });
            
            closeBackupModal.addEventListener('click', () => {
                backupModal.style.display = 'none';
            });
            
            closeFolderModal.addEventListener('click', () => {
                folderModal.style.display = 'none';
            });
            
            // Close modals when clicking outside
            styleModal.addEventListener('click', (e) => {
                if (e.target === styleModal) {
                    styleModal.style.display = 'none';
                }
            });
            
            backupModal.addEventListener('click', (e) => {
                if (e.target === backupModal) {
                    backupModal.style.display = 'none';
                }
            });
            
            folderModal.addEventListener('click', (e) => {
                if (e.target === folderModal) {
                    folderModal.style.display = 'none';
                }
            });
            
            // Add style from URL
            addCustomStyleBtn.addEventListener('click', () => {
                const url = customStyleURL.value.trim();
                if (url) {
                    addCustomStyleFromURL(url);
                    customStyleURL.value = '';
                }
            });
            
            // Add style from file
            customStyleFile.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    addCustomStyleFromFile(e.target.files[0]);
                    e.target.value = '';
                }
            });
            
            // Add style from text input
            saveCustomStyleBtn.addEventListener('click', () => {
                const css = customStyleText.value.trim();
                if (css) {
                    addCustomStyleFromText(css, 'Custom Style');
                    customStyleText.value = '';
                }
            });
            
            // Event Listeners
            createNoteBtn.addEventListener('click', createNewNote);
            tagFilter.addEventListener('change', filterNotes);
            searchInput.addEventListener('input', filterNotes);
            
            // Initialize app
            initDB().then(() => {
                console.log("App initialized successfully");
            }).catch(error => {
                console.error("Error initializing app:", error);
            });
            
            // Functions
            function createNewNote() {
                const newNote = {
                    id: Date.now().toString(),
                    title: 'New Note',
                    content: '# New Note\n\nStart writing your content here...',
                    tags: [],
                    relations: [],
                    folderId: currentFolderId === 'all' ? 'root' : currentFolderId,
                    created: new Date().toISOString(),
                    updated: new Date().toISOString()
                };
                
                notes.push(newNote);
                saveNotes();
                renderNotesList();
                renderNoteEditor(newNote.id);
            }
            
            function renderNotesList() {
                notesContainer.innerHTML = '';
                
                const filterTag = tagFilter.value;
                const searchTerm = searchInput.value.toLowerCase();
                
                // Get notes based on current folder
                let folderNotes = [];
                if (currentFolderId === 'all') {
                    folderNotes = notes;
                } else {
                    folderNotes = getNotesInFolder(currentFolderId, true);
                }
                
                // Filter by tag and search term
                const filteredNotes = folderNotes.filter(note => {
                    const matchesTag = !filterTag || note.tags.includes(filterTag);
                    const matchesSearch = !searchTerm || 
                        note.title.toLowerCase().includes(searchTerm) || 
                        note.content.toLowerCase().includes(searchTerm);
                    
                    return matchesTag && matchesSearch;
                });
                
                if (filteredNotes.length === 0) {
                    const emptyState = document.createElement('div');
                    emptyState.className = 'empty-state';
                    emptyState.innerHTML = `
                        <div class="empty-icon">🔍</div>
                        <h3>No notes found</h3>
                        <p>Try changing your filters or create a new note</p>
                    `;
                    notesContainer.appendChild(emptyState);
                    return;
                }
                
                filteredNotes.sort((a, b) => new Date(b.updated) - new Date(a.updated))
                    .forEach(note => {
                    const noteCard = document.createElement('div');
                    noteCard.className = 'note-card';
                    if (note.id === currentNoteId) {
                        noteCard.style.borderLeft = '3px solid var(--accent-color)';
                    }
                    
                    let tagsHtml = '';
                    if (note.tags.length > 0) {
                        tagsHtml = `
                            <div class="note-tags">
                                ${note.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                            </div>
                        `;
                    }
                    
                    noteCard.innerHTML = `
                        <div class="note-title">${note.title}</div>
                        <div class="note-date">${formatDate(note.updated)}</div>
                        ${tagsHtml}
                    `;
                    
                    noteCard.addEventListener('click', () => {
                        renderNoteViewer(note.id);
                    });
                    
                    notesContainer.appendChild(noteCard);
                });
            }
            
            function updateTagOptions() {
                const allTags = new Set();
                
                notes.forEach(note => {
                    note.tags.forEach(tag => {
                        allTags.add(tag);
                    });
                });
                
                const currentValue = tagFilter.value;
                tagFilter.innerHTML = '<option value="">All Tags</option>';
                
                Array.from(allTags).sort().forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag;
                    option.textContent = tag;
                    
                    if (tag === currentValue) {
                        option.selected = true;
                    }
                    
                    tagFilter.appendChild(option);
                });
            }
            
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
            }
            
            function renderNoteEditor(noteId) {
                isEditing = true;
                currentNoteId = noteId;
                renderNotesList();
                
                const note = notes.find(n => n.id === noteId);
                
                if (!note) {
                    noNoteSelected.style.display = 'flex';
                    return;
                }
                
                noNoteSelected.style.display = 'none';
                
                // Get folder path for breadcrumb
                const folderPath = getFolderPath(note.folderId);
                const folderPathHtml = folderPath.length > 0 ? `
                    <div class="folder-path">
                        Location: ${folderPath.map(f => 
                            `<span class="folder-breadcrumb" data-id="${f.id}">${f.name}</span>`
                        ).join(' > ')}
                    </div>
                ` : '';
                
                mainContent.innerHTML = `
                    <div class="content-header">
                        <div class="content-title">Editing: ${note.title}</div>
                        <div class="action-btns">
                            <button class="save-btn" id="saveNoteBtn">Save</button>
                            <button class="cancel-btn" id="cancelEditBtn">Cancel</button>
                        </div>
                    </div>
                    <div class="content-body">
                        ${folderPathHtml}
                        
                        <div class="note-editor">
                            <input type="text" class="note-input" id="noteTitleInput" placeholder="Note Title" value="${note.title}">
                            
                            <div class="folder-selector">
                                <label for="folderSelect">Folder:</label>
                                <select id="folderSelect">
                                    <option value="root">Root</option>
                                    ${folders.filter(f => f.id !== 'root').map(folder => {
                                        const path = getFolderPath(folder.id).map(f => f.name).join(' > ');
                                        return `<option value="${folder.id}" ${note.folderId === folder.id ? 'selected' : ''}>${path}</option>`;
                                    }).join('')}
                                </select>
                            </div>
                            
                            <div class="tags-input-container" id="tagsContainer">
                                ${note.tags.map(tag => `
                                    <div class="selected-tag">
                                        ${tag}
                                        <span class="remove-tag" data-tag="${tag}">×</span>
                                    </div>
                                `).join('')}
                                <input type="text" class="tags-input" id="tagsInput" placeholder="Add tags...">
                            </div>
                            
                            <div class="relations-container">
                                <h3>Related Notes</h3>
                                <div id="relationsContainer">
                                    ${note.relations.map((relation, index) => `
                                        <div class="relation-item">
                                            <select class="relation-select" data-index="${index}">
                                                <option value="">Select a note...</option>
                                                ${notes.filter(n => n.id !== note.id)
                                                    .map(n => `<option value="${n.id}" ${relation === n.id ? 'selected' : ''}>${n.title}</option>`).join('')}
                                            </select>
                                            <button class="remove-relation" data-index="${index}">×</button>
                                        </div>
                                    `).join('')}
                                </div>
                                <button class="add-relation-btn" id="addRelationBtn">Add Relation</button>
                            </div>
                            
                            <textarea class="note-textarea" id="noteContentInput" placeholder="Note content in Markdown format...">${note.content}</textarea>
                        </div>
                    </div>
                `;
                
                // Set up event listeners for the editor
                document.getElementById('saveNoteBtn').addEventListener('click', () => saveNote(noteId));
                document.getElementById('cancelEditBtn').addEventListener('click', () => renderNoteViewer(noteId));
                
                // Folder breadcrumb navigation
                document.querySelectorAll('.folder-breadcrumb').forEach(crumb => {
                    crumb.addEventListener('click', () => {
                        const folderId = crumb.dataset.id;
                        currentFolderId = folderId;
                        renderNotesList();
                        renderFolderTree();
                    });
                });
                
                // Tags input
                const tagsInput = document.getElementById('tagsInput');
                const tagsContainer = document.getElementById('tagsContainer');
                
                tagsInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ',') {
                        e.preventDefault();
                        const tag = tagsInput.value.trim();
                        
                        if (tag && !note.tags.includes(tag)) {
                            note.tags.push(tag);
                            
                            const tagElement = document.createElement('div');
                            tagElement.className = 'selected-tag';
                            tagElement.innerHTML = `
                                ${tag}
                                <span class="remove-tag" data-tag="${tag}">×</span>
                            `;
                            
                            tagsContainer.insertBefore(tagElement, tagsInput);
                            tagsInput.value = '';
                            
                            // Add event listener to the remove button
                            tagElement.querySelector('.remove-tag').addEventListener('click', () => {
                                note.tags = note.tags.filter(t => t !== tag);
                                tagElement.remove();
                            });
                        }
                        
                        tagsInput.value = '';
                    }
                });
                
                // Add event listeners to existing remove tag buttons
                document.querySelectorAll('.remove-tag').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const tag = btn.getAttribute('data-tag');
                        note.tags = note.tags.filter(t => t !== tag);
                        btn.parentElement.remove();
                    });
                });
                
                // Relations
                document.getElementById('addRelationBtn').addEventListener('click', () => {
                    const relationsContainer = document.getElementById('relationsContainer');
                    const index = note.relations.length;
                    note.relations.push('');
                    
                    const relationItem = document.createElement('div');
                    relationItem.className = 'relation-item';
                    relationItem.innerHTML = `
                        <select class="relation-select" data-index="${index}">
                            <option value="">Select a note...</option>
                            ${notes.filter(n => n.id !== note.id)
                                .map(n => `<option value="${n.id}">${n.title}</option>`).join('')}
                        </select>
                        <button class="remove-relation" data-index="${index}">×</button>
                    `;
                    
                    relationsContainer.appendChild(relationItem);
                    
                    // Add event listeners
                    relationItem.querySelector('.relation-select').addEventListener('change', (e) => {
                        note.relations[index] = e.target.value;
                    });
                    
                    relationItem.querySelector('.remove-relation').addEventListener('click', () => {
                        note.relations.splice(index, 1);
                        relationItem.remove();
                        
                        // Update data indices for remaining relation items
                        document.querySelectorAll('.relation-select, .remove-relation').forEach(el => {
                            const elIndex = parseInt(el.getAttribute('data-index'));
                            if (elIndex > index) {
                                el.setAttribute('data-index', (elIndex - 1).toString());
                            }
                        });
                    });
                });
                
                // Add event listeners to existing relation selects and remove buttons
                document.querySelectorAll('.relation-select').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const index = parseInt(e.target.getAttribute('data-index'));
                        note.relations[index] = e.target.value;
                    });
                });
                
                document.querySelectorAll('.remove-relation').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.getAttribute('data-index'));
                        note.relations.splice(index, 1);
                        e.target.parentElement.remove();
                        
                        // Update data indices for remaining relation items
                        document.querySelectorAll('.relation-select, .remove-relation').forEach(el => {
                            const elIndex = parseInt(el.getAttribute('data-index'));
                            if (elIndex > index) {
                                el.setAttribute('data-index', (elIndex - 1).toString());
                            }
                        });
                    });
                });
            }
            
            function saveNote(noteId) {
                const note = notes.find(n => n.id === noteId);
                
                if (!note) return;
                
                note.title = document.getElementById('noteTitleInput').value.trim() || 'Untitled';
                note.content = document.getElementById('noteContentInput').value;
                note.folderId = document.getElementById('folderSelect').value;
                note.updated = new Date().toISOString();
                
                saveNotes();
                renderNoteViewer(noteId);
                showToast("Note saved successfully!", "success");
            }
            
            function renderNoteViewer(noteId) {
                isEditing = false;
                currentNoteId = noteId;
                renderNotesList();
                
                const note = notes.find(n => n.id === noteId);
                
                if (!note) {
                    noNoteSelected.style.display = 'flex';
                    return;
                }
                
                noNoteSelected.style.display = 'none';
                
                // Get folder path for breadcrumb
                const folderPath = getFolderPath(note.folderId);
                const folderPathHtml = folderPath.length > 0 ? `
                    <div class="folder-path">
                        Location: ${folderPath.map(f => 
                            `<span class="folder-breadcrumb" data-id="${f.id}">${f.name}</span>`
                        ).join(' > ')}
                    </div>
                ` : '';
                
                // Prepare related notes
                let relatedNotesHtml = '';
                if (note.relations.length > 0) {
                    const relatedNotes = notes.filter(n => note.relations.includes(n.id));
                    
                    if (relatedNotes.length > 0) {
                        relatedNotesHtml = `
                            <div class="related-notes">
                                <div class="related-title">Related Notes</div>
                                <div class="related-list">
                                    ${relatedNotes.map(rn => `
                                        <div class="related-item" data-id="${rn.id}">
                                            ${rn.title}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Render the note viewer
                mainContent.innerHTML = `
                    <div class="content-header">
                        <div class="content-title">${note.title}</div>
                        <div class="action-btns">
                            <button class="edit-btn" id="editNoteBtn">Edit</button>
                            <button class="delete-btn" id="deleteNoteBtn">Delete</button>
                        </div>
                    </div>
                    <div class="content-body">
                        ${folderPathHtml}
                        
                        ${note.tags.length > 0 ? `
                            <div class="note-tags" style="margin-bottom: 15px;">
                                ${note.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                        
                        <div class="markdown-content">
                            ${marked.parse(note.content)}
                        </div>
                        
                        ${relatedNotesHtml}
                    </div>
                `;
                
                // Add event listeners
                document.getElementById('editNoteBtn').addEventListener('click', () => renderNoteEditor(noteId));
                document.getElementById('deleteNoteBtn').addEventListener('click', () => confirmDeleteNote(noteId));
                
                // Folder breadcrumb navigation
                document.querySelectorAll('.folder-breadcrumb').forEach(crumb => {
                    crumb.addEventListener('click', () => {
                        const folderId = crumb.dataset.id;
                        currentFolderId = folderId;
                        renderNotesList();
                        renderFolderTree();
                    });
                });
                
                // Add event listeners to related note items
                document.querySelectorAll('.related-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const relatedId = item.getAttribute('data-id');
                        renderNoteViewer(relatedId);
                    });
                });
            }
            
            function confirmDeleteNote(noteId) {
                if (confirm('Are you sure you want to delete this note? This action cannot be undone.')) {
                    deleteNote(noteId);
                }
            }
            
            function deleteNote(noteId) {
                notes = notes.filter(n => n.id !== noteId);
                
                // Also remove relations to this note from other notes
                notes.forEach(note => {
                    note.relations = note.relations.filter(r => r !== noteId);
                });
                
                saveNotes();
                currentNoteId = null;
                noNoteSelected.style.display = 'flex';
                renderNotesList();
                showToast("Note deleted successfully", "info");
            }
            
            function filterNotes() {
                renderNotesList();
            }
        });
    </script>
</body>
</html>
